{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}CRM{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome - основне підключення -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Резервне підключення Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    
    <!-- Додаткове підключення для забезпечення роботи -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.css">
            <link rel="stylesheet" href="{% static 'crm/css/base.css' %}?v=2024090305">
    {% block extra_css %}{% endblock %}
</head>
<body class="light-theme">

<nav class="navbar navbar-expand-lg navbar-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <i class="fas fa-building"></i> CRM Logistics
    </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'orders_list' %}">
            <i class="fas fa-shopping-cart"></i> Замовлення
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'clients_list' %}">
            <i class="fas fa-users"></i> Клієнти
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'couriers_list' %}">
            <i class="fas fa-motorcycle"></i> Кур'єри
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'payments_list' %}">
            <i class="fas fa-credit-card"></i> Платежі
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="logisticsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-route"></i> Логістика
          </a>
          <ul class="dropdown-menu shadow">
            <li>
              <a class="dropdown-item" href="{% url 'logistics_dashboard' %}">
                <i class="fas fa-tachometer-alt text-primary"></i> Панель управління
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="{% url 'route_optimization' %}">
                <i class="fas fa-route text-success"></i> Оптимізація маршрутів
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'courier_tracking' %}">
                <i class="fas fa-map-marker-alt text-warning"></i> Відстеження кур'єрів
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'delivery_analytics' %}">
                <i class="fas fa-chart-bar text-info"></i> Аналітика доставки
              </a>
            </li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'dashboard' %}">
            <i class="fas fa-chart-line"></i> Статистика
          </a>
        </li>
      </ul>

      <div class="d-flex ms-auto align-items-center">
        {% if user.is_authenticated %}
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-user-circle me-2"></i>
              {{ user.username }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-0 border-0" aria-labelledby="userDropdown" style="min-width: 300px;">
              <div class="card shadow border-0 m-2">
                <div class="card-body">
                  <h5 class="card-title mb-2">{{ user.username }}</h5>
                  <p class="card-text mb-1 text-muted small"><strong>Email:</strong> {{ user.email }}</p>
                  <p class="card-text mb-1 text-muted small"><strong>Дата реєстрації:</strong> {{ user.date_joined|date:"d.m.Y H:i" }}</p>
                  <p class="card-text mb-3 text-muted small"><strong>Статус:</strong>
                    {% if user.is_superuser %}Адмін{% else %}Користувач{% endif %}
                  </p>
                  <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button class="btn btn-danger w-100 fw-bold" type="submit">Вийти</button>
                  </form>
                </div>
              </div>
            </ul>
          </div>
        {% else %}
          <a class="btn btn-warning fw-bold" href="{% url 'login' %}">Увійти</a>
        {% endif %}

        <button id="themeToggle" class="btn btn-outline-light ms-3" title="Змінити тему">
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
      </div>
    </div>
  </div>
</nav>

<div class="container">
    {% block content %}{% endblock %}
</div>

<form id="csrfForm" method="post" style="display: none;">
  {% csrf_token %}
</form>

<!-- Include Support Widget -->
{% include 'crm/support_widget.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome Fallback Script -->
<script>
// Перевірка завантаження Font Awesome
document.addEventListener('DOMContentLoaded', function() {
    // Перевіряємо, чи завантажився Font Awesome
    const testIcon = document.createElement('i');
    testIcon.className = 'fas fa-check';
    testIcon.style.display = 'none';
    document.body.appendChild(testIcon);
    
    // Якщо Font Awesome не завантажився, завантажуємо резервну версію
    if (getComputedStyle(testIcon, ':before').content === 'none' || 
        getComputedStyle(testIcon, ':before').content === 'normal') {
        
        console.log('Font Awesome не завантажився, завантажую резервну версію...');
        
        // Завантажуємо резервну версію Font Awesome
        const fallbackLink = document.createElement('link');
        fallbackLink.rel = 'stylesheet';
        fallbackLink.href = 'https://use.fontawesome.com/releases/v6.4.0/css/all.css';
        document.head.appendChild(fallbackLink);
        
        // Додаткове резервне підключення
        const fallbackLink2 = document.createElement('link');
        fallbackLink2.rel = 'stylesheet';
        fallbackLink2.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.css';
        document.head.appendChild(fallbackLink2);
    }
    
    // Видаляємо тестовий елемент
    document.body.removeChild(testIcon);
});
</script>

{% block extra_js %}{% endblock %}
<script>
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const body = document.body;

// Ініціалізація теми з localStorage
function initTheme() {
    console.log('Initializing theme, current localStorage theme:', localStorage.getItem('theme'));
    if(localStorage.getItem('theme') === 'dark') {
        body.classList.add('dark-theme');
        body.classList.remove('light-theme');
        themeIcon.className = 'fas fa-sun';
        themeToggle.title = 'Переключити на світлу тему';
        console.log('Applied dark theme');
    } else {
        body.classList.add('light-theme');
        body.classList.remove('dark-theme');
        themeIcon.className = 'fas fa-moon';
        themeToggle.title = 'Переключити на темну тему';
        console.log('Applied light theme');
    }
    console.log('Body classes:', body.className);
}

// Перемикання теми з анімацією
themeToggle.addEventListener('click', () => {
    console.log('Theme toggle clicked!');
    // Додаємо анімацію кнопки
    themeToggle.style.transform = 'scale(0.8)';
    setTimeout(() => {
        themeToggle.style.transform = 'scale(1)';
    }, 150);
    
    if(body.classList.contains('dark-theme')) {
        body.classList.remove('dark-theme');
        body.classList.add('light-theme');
        themeIcon.className = 'fas fa-moon';
        themeToggle.title = 'Переключити на темну тему';
        localStorage.setItem('theme', 'light');
        console.log('Switched to light theme');
    } else {
        body.classList.remove('light-theme');
        body.classList.add('dark-theme');
        themeIcon.className = 'fas fa-sun';
        themeToggle.title = 'Переключити на світлу тему';
        localStorage.setItem('theme', 'dark');
        console.log('Switched to dark theme');
    }
    console.log('New body classes:', body.className);
});

// Додати стилі для анімації кнопки теми
themeToggle.style.transition = 'all 0.3s ease';

// Ініціалізувати тему при завантаженні
initTheme();
</script>
</body>
</html>
