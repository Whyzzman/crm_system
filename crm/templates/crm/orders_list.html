{% extends "crm/base.html" %}

{% block content %}
<h2>–ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
{% if user.is_superuser or user.is_staff %}
<a class="btn btn-primary mb-3" href="{% url 'order_create' %}">‚ûï –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
{% endif %}
{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<form method="get" class="mb-3 d-flex gap-2">
    <input type="text" name="q" placeholder="–ü–æ—à—É–∫ –∑–∞ —Ç–æ–≤–∞—Ä–æ–º" class="form-control" value="{{ request.GET.q }}">

    <select name="status" class="form-select">
        <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>–ù–æ–≤—ñ</option>
        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>–í –ø—Ä–æ—Ü–µ—Å—ñ</option>
        <option value="done" {% if status_filter == 'done' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</option>
    </select>

    <select name="courier" class="form-select">
        <option value="">–í—Å—ñ –∫—É—Ä'—î—Ä–∏</option>
        {% for courier in couriers %}
            <option value="{{ courier.id }}" {% if courier_filter == courier.id|stringformat:"s" %}selected{% endif %}>
                {{ courier.name }}
            </option>
        {% endfor %}
    </select>

    <button class="btn btn-secondary" type="submit">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
</form>

<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>–ö–ª—ñ—î–Ω—Ç</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–ê–¥—Ä–µ—Å–∞</th>
            <th>–ö—É—Ä'—î—Ä</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–î—ñ—ó</th>
        </tr>
    </thead>
    <tbody>
    {% for order in orders %}
        <tr>
            <td>{{ order.client.name }}</td>
            <td>{{ order.product }}</td>
            <td>{{ order.quantity }}</td>
            <td>{{ order.address }}</td>
            <td>{{ order.courier }}</td>
            <td>{{ order.get_status_display }}</td>
            <td>
                {% if order.total_price %}
                    <strong>{{ order.total_price }} –≥—Ä–Ω</strong>
                {% else %}
                    <span class="text-muted">–ù–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                {% endif %}
            </td>
            <td>
                {% if order.is_paid %}
                    <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ</span>
                {% else %}
                    <span class="badge bg-warning">{{ order.payment_status_display }}</span>
                    {% if user.is_superuser or user.is_staff %}
                        {% if order.total_price %}
                            <br>
                            <div class="btn-group mt-1" role="group">
                                <a href="{% url 'payment_cash' order.id %}" class="btn btn-success btn-sm">
                                    üí∞ –ì–æ—Ç—ñ–≤–∫–∞
                                </a>
                                <a href="{% url 'payment_quick' order.id %}" class="btn btn-primary btn-sm">
                                    üí≥ –ö–∞—Ä—Ç–∫–∞
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </td>
            <td>
                {% if user.is_superuser or user.is_staff %}
                <a href="{% url 'order_update' order.pk %}" class="btn btn-warning btn-sm">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                <a href="{% url 'order_delete' order.pk %}" class="btn btn-danger btn-sm">–í–∏–¥–∞–ª–∏—Ç–∏</a>
                {% if order.payment and not order.is_paid %}
                    <br><a href="{% url 'payment_detail' order.payment.id %}" class="btn btn-info btn-sm mt-1">–ü–ª–∞—Ç—ñ–∂</a>
                {% endif %}
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr><td colspan="9" class="text-center">–ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</td></tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}